# ErnestAi.Audio - Audio Processing Components

## Purpose
The ErnestAi.Audio project handles all audio input and output operations for the ErnestAi system. It provides implementations for recording audio from microphones, playing audio through speakers, and managing audio streams for real-time processing.

## Current State
- Recording is synchronized and robust:
  - Waits for first audio buffer before considering recording started.
  - Waits for `RecordingStopped` to ensure all buffers are flushed.
  - Uses `NAudio.Utils.IgnoreDisposeStream` to prevent premature disposal of underlying streams.
  - Enforces a minimum WAV size before returning recorded audio.
- Wake word detection is config-driven and validated at startup.

## Key Components

### Audio Processor
- Implements the `IAudioProcessor` interface from ErnestAi.Core
- Handles audio device management and selection
- Provides audio recording and playback capabilities
- Manages audio streaming for real-time processing
  - Produces finalized WAV streams suitable for Whisper

### Voice Activity Detection
- Detects when someone is speaking vs. silence
- Helps optimize audio processing by only processing relevant audio segments
- Configurable sensitivity and thresholds

### Audio Format Conversion
- Converts between different audio formats as needed
- Handles resampling, bit depth conversion, and channel mapping
- Ensures compatibility with various speech recognition and synthesis systems

### Audio Device Management
- Enumerates available audio input and output devices
- Monitors device changes (connect/disconnect)
- Provides device selection and configuration

## Dependencies
- ErnestAi.Core - For core interfaces
- NAudio - For Windows audio capture and playback (implementation detail)

## Implementation Notes
- Uses NAudio for Windows audio device access
- Implements buffered audio processing for efficient memory usage
- Supports configurable audio quality settings
- Handles audio device errors and fallbacks
 - Uses `IgnoreDisposeStream` to keep underlying memory streams alive until copied
 - Aligns recording lifecycle with `WakeWordDetector` to ensure valid WAV output

## Development Guidelines
- Keep audio processing code isolated from business logic
- Use proper buffering to avoid audio glitches
- Handle device disconnection gracefully
- Consider cross-platform compatibility for future development
- Implement proper resource disposal for audio devices

## Related Files
- Root INFO.ai: `../INFO.ai`
- Core interfaces: `../ErnestAi.Core/INFO.ai`
 - Speech services: `../ErnestAi.Speech/INFO.ai`
 - Host composition: `../ErnestAi.Host/INFO.ai`

## Key Files
- `AudioProcessor.cs` — recording, playback, and stream lifecycle handling
- `WakeWordDetector.cs` — wake word detection and WAV preparation
